<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.co.iei.admin.model.dao.AdminDao">

    <!--영화 목록 -->
    <select id="adminMovieList" resultType="movie" parameterType="map">
        SELECT *
        FROM movie_tbl
        <where>
            <if test="movieTitle != null and movieTitle != ''">
                AND movie_title LIKE '%' || #{movieTitle} || '%'
            </if>
            <if test="movieStatus != null">
                <choose>
                    <!-- 개봉 예정 -->
                    <when test="movieStatus eq 1">
                        AND movie_release &gt; SYSDATE
                    </when>
                    <!-- 상영 중 -->
                    <when test="movieStatus eq 2">
                        AND movie_release BETWEEN ADD_MONTHS(SYSDATE, -1) AND SYSDATE
                    </when>
                    <!-- 상영 종료 -->
                    <when test="movieStatus eq 3">
                        AND movie_release &lt;= ADD_MONTHS(SYSDATE, -1)
                        AND movie_status != 4
                    </when>
                    <!-- 재개봉 -->
                    <when test="movieStatus eq 4">
                        AND movie_status = 4
                    </when>
                </choose>
            </if>
        </where>
        ORDER BY movie_no DESC
    </select>

    <!-- 영화 상세 -->
    <select id="selectOneMovie" resultType="movie">
        SELECT * FROM movie_tbl WHERE movie_no = #{movieNo}
    </select>

    <!-- 영화 번호 발급 -->
    <select id="getMovieNo" resultType="int">
        SELECT movie_seq.NEXTVAL FROM dual
    </select>

    <!-- 영화 상태 변경 -->
    <update id="updateMovieStatus">
        UPDATE movie_tbl
        SET movie_status = #{movieStatus}
        WHERE movie_no = #{movieNo}
    </update>

    <!-- 영화 등록 -->
    <insert id="insertMovieInfo">
        INSERT INTO movie_tbl (
            movie_no, movie_type, movie_title, movie_status,
            movie_content, movie_thumb, movie_genre, movie_grade,
            movie_runtime, movie_director, movie_actor, movie_release
        )
        VALUES (
            movie_seq.nextval,
            #{movieType}, #{movieTitle}, #{movieStatus}, #{movieContent},
            #{movieThumb}, #{movieGenre}, #{movieGrade}, #{movieRuntime},
            #{movieDirector}, #{movieActor}, #{movieRelease}
        )
    </insert>

    <!-- 영화 개수 조회 -->
    <select id="totalCount" resultType="int" parameterType="map">
        SELECT COUNT(*)
        FROM movie_tbl
        <where>
            <if test="movieTitle != null and movieTitle != ''">
                AND movie_title LIKE '%' || #{movieTitle} || '%'
            </if>
            <if test="movieStatus != null">
                AND movie_status = #{movieStatus}
            </if>
        </where>
    </select>

    <!--  스케줄 등록 -->
    <insert id="insertSchedule" parameterType="schedule">
        INSERT INTO schedule_tbl (
            schedule_no,
            movie_no,
            screen_no,
            schedule_time_start,
            schedule_time_end,
            schedule_open,
            schedule_close
        )
        VALUES (
            schedule_seq.nextval,
            #{movieNo},
            #{screenNo},
            TO_DATE(#{scheduleTimeStart}, 'HH24:MI'),
            TO_DATE(#{scheduleTimeEnd}, 'HH24:MI'),
            TO_DATE(#{scheduleOpen}, 'YYYY-MM-DD'),
            TO_DATE(#{scheduleClose}, 'YYYY-MM-DD')
        )
    </insert>

    <!-- 상영 중 / 재개봉 영화 -->
    <select id="getRunningMovies" resultType="movie">
        SELECT movie_no, movie_title, movie_thumb, movie_status, movie_runtime
        FROM movie_tbl
        WHERE movie_status IN (2, 4)
    </select>

    <!-- 스케줄 목록 -->
    <select id="scheduleList" resultType="schedule">
        SELECT
            s.schedule_no AS scheduleNo,
            s.movie_no AS movieNo,
            m.movie_title AS movieTitle,
            s.screen_no AS screenNo,
            TO_CHAR(s.schedule_open, 'YYYY-MM-DD') AS scheduleOpen,
            TO_CHAR(s.schedule_close, 'YYYY-MM-DD') AS scheduleClose,
            TO_CHAR(s.schedule_time_start, 'HH24:MI') AS scheduleTimeStart,
            TO_CHAR(s.schedule_time_end, 'HH24:MI') AS scheduleTimeEnd
        FROM schedule_tbl s
        JOIN movie_tbl m ON s.movie_no = m.movie_no
        ORDER BY s.schedule_no DESC
    </select>

    <!-- 스케줄 수정 -->
    <update id="updateSchedule">
        UPDATE schedule_tbl
        SET
            screen_no = #{screenNo},
            schedule_open = TO_DATE(#{scheduleOpen}, 'YYYY-MM-DD'),
            schedule_close = TO_DATE(#{scheduleClose}, 'YYYY-MM-DD'),
            schedule_time_start = #{scheduleTimeStart},
            schedule_time_end = #{scheduleTimeEnd}
        WHERE schedule_no = #{scheduleNo}
    </update>

    <!-- 스케줄 삭제 -->
    <delete id="deleteSchedule" parameterType="int">
        DELETE FROM schedule_tbl WHERE schedule_no = #{scheduleNo}
    </delete>

	<!-- 단일 스케줄 조회 -->
	<select id="getScheduleDetail" parameterType="int" resultType="schedule">
    SELECT 
        s.schedule_no,
        s.movie_no,
        m.movie_title,
        s.screen_no,
        s.schedule_open,
        s.schedule_close,
        s.schedule_time_start,
        s.schedule_time_end
    FROM schedule_tbl s
    JOIN movie_tbl m ON s.movie_no = m.movie_no
    WHERE s.schedule_no = #{scheduleNo}
	</select>
	

    <!-- 선택된 시간 제외 -->
    <select id="getOccupiedTimes" resultType="map">
        SELECT 
            TO_CHAR(schedule_time_start, 'HH24:MI') AS startTime,
            TO_CHAR(schedule_time_end, 'HH24:MI') AS endTime
        FROM schedule_tbl
        WHERE screen_no = #{screenNo}
          AND TO_CHAR(schedule_open, 'YYYY-MM-DD') = #{scheduleOpen}
    </select>

    <!-- 상영시간 중복 체크 -->
    <select id="checkTimeConflict" parameterType="schedule" resultType="int">
        SELECT COUNT(*)
        FROM schedule_tbl
        WHERE screen_no = #{screenNo}
          AND TRUNC(schedule_open) = TO_DATE(#{scheduleOpen}, 'YYYY-MM-DD')
          AND (
            (MOD((schedule_time_start - TRUNC(schedule_time_start)) * 24 * 60, 1440)
              &lt; TO_NUMBER(SUBSTR(#{scheduleTimeEnd}, 1, 2)) * 60 
                + TO_NUMBER(SUBSTR(#{scheduleTimeEnd}, 4, 2))
             AND
             MOD((schedule_time_end - TRUNC(schedule_time_end)) * 24 * 60, 1440)
              &gt; TO_NUMBER(SUBSTR(#{scheduleTimeStart}, 1, 2)) * 60 
                + TO_NUMBER(SUBSTR(#{scheduleTimeStart}, 4, 2)))
          )
    </select>

    <!-- 주간 스케줄 -->
    <select id="getWeeklySchedule" resultType="schedule" parameterType="map">
        SELECT
            s.schedule_no AS scheduleNo,
            s.movie_no AS movieNo,
            m.movie_title AS movieTitle,
            s.screen_no AS screenNo,
            TO_CHAR(s.schedule_open, 'YYYY-MM-DD') AS scheduleOpen,
            TO_CHAR(s.schedule_time_start, 'HH24:MI') AS scheduleTimeStart,
            TO_CHAR(s.schedule_time_end, 'HH24:MI') AS scheduleTimeEnd
        FROM schedule_tbl s
        JOIN movie_tbl m ON s.movie_no = m.movie_no
        WHERE s.schedule_open BETWEEN TO_DATE(#{startDate}, 'YYYY-MM-DD')
                                 AND TO_DATE(#{startDate}, 'YYYY-MM-DD') + 6
        ORDER BY s.schedule_open, s.screen_no, s.schedule_time_start
    </select>

    <!--회원 관리 -->
    <select id="totalMemberCount" parameterType="string" resultType="int">
        SELECT COUNT(*)
        FROM member_tbl
        <where>
            <if test="memberId != null and memberId != ''">
                AND member_id LIKE '%' || #{memberId} || '%'
            </if>
        </where>
    </select>
	
	<select id="adminMemberList" parameterType="map" resultType="member">
	    SELECT *
	    FROM (
	        SELECT ROWNUM rnum, a.*
	        FROM (
	            SELECT member_no, member_id, member_name, member_phone, member_email
	            FROM member_tbl
	            <where>
	                <if test="memberId != null and memberId != ''">
	                    AND member_id LIKE '%' || #{memberId} || '%'
	                </if>
	            </where>
	            ORDER BY member_no DESC
	        ) a
	    )
	    WHERE rnum BETWEEN #{start} AND #{end}
	</select>

    <!--신고된 회원 목록 -->
	<select id="getReportedMembers" resultType="map">
	    SELECT DISTINCT 
	        m_reported.member_no AS MEMBER_NO,              
	        m_reported.member_id AS MEMBER_ID,              
	        r.reported_member_no AS REPORTED_MEMBER_NO,     
	        c.comment_content AS REPORTED_COMMENT,
	        r.comment_report_date AS COMMENT_REPORT_DATE
	    FROM comment_report_tbl r
	    JOIN member_tbl m_reported ON r.reported_member_no = m_reported.member_no 
	    JOIN movie_comment_tbl c ON r.movie_comment_no = c.movie_comment_no
	    ORDER BY r.comment_report_date DESC
    </select>

    <!-- 정지회원 중복 체크 -->
<select id="checkAlreadySuspended" parameterType="int" resultType="int">
    SELECT COUNT(*)
    FROM member_suspend
    WHERE member_no = #{memberNo}
    AND suspend_date + suspend_days > SYSDATE
</select>

<!-- 정지 등록 -->
<insert id="insertSuspend" parameterType="map">
    INSERT INTO member_suspend (
        suspend_no,
        member_no,
        suspend_date,
        suspend_days,
        suspend_reason,
        suspended_until
    )
    VALUES (
        suspend_seq.NEXTVAL,
        #{memberNo},
        SYSDATE,
        #{suspendDays},
        #{suspendReason},
        SYSDATE + #{suspendDays}
    )
</insert>
	
	<!-- ⭐️ 현재 유효한 정지 정보 조회  -->
	<select id="getValidSuspensionInfo" parameterType="int" resultType="map">
	    SELECT 
	        suspend_days AS SUSPENDED_DAYS,
	        suspend_date AS SUSPENDED_AT,
	        suspend_date + suspend_days AS SUSPENDED_UNTIL,  <!-- 종료일 계산 -->
	        suspend_reason AS REASON
	    FROM member_suspend
	    WHERE member_no = #{memberNo}
	    AND suspend_date + suspend_days > SYSDATE  <!-- 정지 종료일이 현재 시각보다 미래인 경우만 유효 -->
	    ORDER BY SUSPENDED_UNTIL DESC  <!-- 혹시 중복 정지가 있다면 가장 나중에 끝나는 정지 정보를 가져옴 -->
	    FETCH FIRST 1 ROW ONLY 
	</select>


</mapper>
