<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.co.iei.admin.model.dao.AdminDao">

    <!-- ðŸŽ¬ ì˜í™” ëª©ë¡ -->
    <select id="adminMovieList" resultType="movie" parameterType="map">
        SELECT *
        FROM movie_tbl
        <where>
            <if test="movieTitle != null and movieTitle != ''">
                AND movie_title LIKE '%' || #{movieTitle} || '%'
            </if>
            <if test="movieStatus != null">
                <choose>
                    <!-- ê°œë´‰ ì˜ˆì • -->
                    <when test="movieStatus eq 1">
                        AND movie_release &gt; SYSDATE
                    </when>
                    <!-- ìƒì˜ ì¤‘ -->
                    <when test="movieStatus eq 2">
                        AND movie_release BETWEEN ADD_MONTHS(SYSDATE, -1) AND SYSDATE
                    </when>
                    <!-- ìƒì˜ ì¢…ë£Œ -->
                    <when test="movieStatus eq 3">
                        AND movie_release &lt;= ADD_MONTHS(SYSDATE, -1)
                        AND movie_status != 4
                    </when>
                    <!-- ìž¬ê°œë´‰ -->
                    <when test="movieStatus eq 4">
                        AND movie_status = 4
                    </when>
                </choose>
            </if>
        </where>
        ORDER BY movie_no DESC
    </select>

    <!-- ì˜í™” ìƒì„¸ -->
    <select id="selectOneMovie" resultType="movie">
        SELECT * FROM movie_tbl WHERE movie_no = #{movieNo}
    </select>

    <!-- ì˜í™” ë²ˆí˜¸ ë°œê¸‰ -->
    <select id="getMovieNo" resultType="int">
        SELECT movie_seq.NEXTVAL FROM dual
    </select>

    <!-- ì˜í™” ìƒíƒœ ë³€ê²½ -->
    <update id="updateMovieStatus">
        UPDATE movie_tbl
        SET movie_status = #{movieStatus}
        WHERE movie_no = #{movieNo}
    </update>

    <!-- ì˜í™” ë“±ë¡ -->
    <insert id="insertMovieInfo">
        INSERT INTO movie_tbl (
            movie_no, movie_type, movie_title, movie_status,
            movie_content, movie_thumb, movie_genre, movie_grade,
            movie_runtime, movie_director, movie_actor, movie_release
        )
        VALUES (
            movie_seq.nextval,
            #{movieType}, #{movieTitle}, #{movieStatus}, #{movieContent},
            #{movieThumb}, #{movieGenre}, #{movieGrade}, #{movieRuntime},
            #{movieDirector}, #{movieActor}, #{movieRelease}
        )
    </insert>

    <!-- ì˜í™” ê°œìˆ˜ ì¡°íšŒ -->
    <select id="totalCount" resultType="int" parameterType="map">
        SELECT COUNT(*)
        FROM movie_tbl
        <where>
            <if test="movieTitle != null and movieTitle != ''">
                AND movie_title LIKE '%' || #{movieTitle} || '%'
            </if>
            <if test="movieStatus != null">
                AND movie_status = #{movieStatus}
            </if>
        </where>
    </select>

    <!-- ðŸŽž ìŠ¤ì¼€ì¤„ ë“±ë¡ -->
    <insert id="insertSchedule" parameterType="schedule">
        INSERT INTO schedule_tbl (
            schedule_no,
            movie_no,
            screen_no,
            schedule_time_start,
            schedule_time_end,
            schedule_open,
            schedule_close
        )
        VALUES (
            schedule_seq.nextval,
            #{movieNo},
            #{screenNo},
            TO_DATE(#{scheduleTimeStart}, 'HH24:MI'),
            TO_DATE(#{scheduleTimeEnd}, 'HH24:MI'),
            TO_DATE(#{scheduleOpen}, 'YYYY-MM-DD'),
            TO_DATE(#{scheduleClose}, 'YYYY-MM-DD')
        )
    </insert>

    <!-- ìƒì˜ ì¤‘ / ìž¬ê°œë´‰ ì˜í™” -->
    <select id="getRunningMovies" resultType="movie">
        SELECT movie_no, movie_title, movie_thumb, movie_status, movie_runtime
        FROM movie_tbl
        WHERE movie_status IN (2, 4)
    </select>

    <!-- ìŠ¤ì¼€ì¤„ ëª©ë¡ -->
    <select id="scheduleList" resultType="schedule">
        SELECT
            s.schedule_no AS scheduleNo,
            s.movie_no AS movieNo,
            m.movie_title AS movieTitle,
            s.screen_no AS screenNo,
            TO_CHAR(s.schedule_open, 'YYYY-MM-DD') AS scheduleOpen,
            TO_CHAR(s.schedule_close, 'YYYY-MM-DD') AS scheduleClose,
            TO_CHAR(s.schedule_time_start, 'HH24:MI') AS scheduleTimeStart,
            TO_CHAR(s.schedule_time_end, 'HH24:MI') AS scheduleTimeEnd
        FROM schedule_tbl s
        JOIN movie_tbl m ON s.movie_no = m.movie_no
        ORDER BY s.schedule_no DESC
    </select>

    <!-- ìŠ¤ì¼€ì¤„ ìˆ˜ì • -->
    <update id="updateSchedule">
        UPDATE schedule_tbl
        SET
            screen_no = #{screenNo},
            schedule_open = TO_DATE(#{scheduleOpen}, 'YYYY-MM-DD'),
            schedule_close = TO_DATE(#{scheduleClose}, 'YYYY-MM-DD'),
            schedule_time_start = #{scheduleTimeStart},
            schedule_time_end = #{scheduleTimeEnd}
        WHERE schedule_no = #{scheduleNo}
    </update>

    <!-- ìŠ¤ì¼€ì¤„ ì‚­ì œ -->
    <delete id="deleteSchedule" parameterType="int">
        DELETE FROM schedule_tbl WHERE schedule_no = #{scheduleNo}
    </delete>

    <!-- ì„ íƒëœ ì‹œê°„ ì œì™¸ -->
    <select id="getOccupiedTimes" resultType="map">
        SELECT 
            TO_CHAR(schedule_time_start, 'HH24:MI') AS startTime,
            TO_CHAR(schedule_time_end, 'HH24:MI') AS endTime
        FROM schedule_tbl
        WHERE screen_no = #{screenNo}
          AND TO_CHAR(schedule_open, 'YYYY-MM-DD') = #{scheduleOpen}
    </select>

    <!-- ìƒì˜ì‹œê°„ ì¤‘ë³µ ì²´í¬ -->
    <select id="checkTimeConflict" parameterType="schedule" resultType="int">
        SELECT COUNT(*)
        FROM schedule_tbl
        WHERE screen_no = #{screenNo}
          AND TRUNC(schedule_open) = TO_DATE(#{scheduleOpen}, 'YYYY-MM-DD')
          AND (
            (MOD((schedule_time_start - TRUNC(schedule_time_start)) * 24 * 60, 1440)
              &lt; TO_NUMBER(SUBSTR(#{scheduleTimeEnd}, 1, 2)) * 60 
                + TO_NUMBER(SUBSTR(#{scheduleTimeEnd}, 4, 2))
             AND
             MOD((schedule_time_end - TRUNC(schedule_time_end)) * 24 * 60, 1440)
              &gt; TO_NUMBER(SUBSTR(#{scheduleTimeStart}, 1, 2)) * 60 
                + TO_NUMBER(SUBSTR(#{scheduleTimeStart}, 4, 2)))
          )
    </select>

    <!-- ì£¼ê°„ ìŠ¤ì¼€ì¤„ -->
    <select id="getWeeklySchedule" resultType="schedule" parameterType="map">
        SELECT
            s.schedule_no AS scheduleNo,
            s.movie_no AS movieNo,
            m.movie_title AS movieTitle,
            s.screen_no AS screenNo,
            TO_CHAR(s.schedule_open, 'YYYY-MM-DD') AS scheduleOpen,
            TO_CHAR(s.schedule_time_start, 'HH24:MI') AS scheduleTimeStart,
            TO_CHAR(s.schedule_time_end, 'HH24:MI') AS scheduleTimeEnd
        FROM schedule_tbl s
        JOIN movie_tbl m ON s.movie_no = m.movie_no
        WHERE s.schedule_open BETWEEN TO_DATE(#{startDate}, 'YYYY-MM-DD')
                                 AND TO_DATE(#{startDate}, 'YYYY-MM-DD') + 6
        ORDER BY s.schedule_open, s.screen_no, s.schedule_time_start
    </select>

    <!-- ðŸ‘¥ íšŒì› ê´€ë¦¬ -->
    <select id="totalMemberCount" parameterType="string" resultType="int">
        SELECT COUNT(*)
        FROM member_tbl
        <where>
            <if test="memberId != null and memberId != ''">
                AND member_id LIKE '%' || #{memberId} || '%'
            </if>
        </where>
    </select>
	
	<select id="adminMemberList" parameterType="map" resultType="member">
	    SELECT *
	    FROM (
	        SELECT ROWNUM rnum, a.*
	        FROM (
	            SELECT member_no, member_id, member_name, member_phone, member_email
	            FROM member_tbl
	            <where>
	                <if test="memberId != null and memberId != ''">
	                    AND member_id LIKE '%' || #{memberId} || '%'
	                </if>
	            </where>
	            ORDER BY member_no DESC
	        ) a
	    )
	    WHERE rnum BETWEEN #{start} AND #{end}
	</select>

    <!-- ðŸš¨ ì‹ ê³ ëœ íšŒì› ëª©ë¡ -->
	<select id="getReportedMembers" resultType="map">
        SELECT DISTINCT 
            m.member_no AS member_no,
            m.member_id AS member_id,
            c.comment_content AS reported_comment,
            r.comment_report_date AS comment_report_date
        FROM comment_report_tbl r
        JOIN member_tbl m ON r.member_no = m.member_no
        JOIN movie_comment_tbl c ON r.movie_comment_no = c.movie_comment_no
        ORDER BY r.comment_report_date DESC
    </select>

    <!-- â›” ì •ì§€ ë“±ë¡ -->
	<insert id="insertMemberSuspend" parameterType="map">
        INSERT INTO member_suspend (
            suspend_no,
            member_no,
            suspend_date,
            suspend_days,
            suspend_reason
        )
        VALUES (
            suspend_seq.NEXTVAL,
            #{memberNo},
            SYSDATE,
            #{suspendDays},
            #{suspendReason}
        )
    </insert>

</mapper>
