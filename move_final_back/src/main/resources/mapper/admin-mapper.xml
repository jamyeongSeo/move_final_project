<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.co.iei.admin.model.dao.AdminDao">

<select id="adminMovieList" resultType="movie" parameterType="map">
    SELECT *
    FROM movie_tbl
    <where>
        <if test="movieTitle != null and movieTitle != ''">
            AND movie_title LIKE '%' || #{movieTitle} || '%'
        </if>
        <if test="movieStatus != null">
            AND movie_status = #{movieStatus}
        </if>
    </where>
    ORDER BY movie_no DESC
</select>

	<select id="selectOneMovie" resultType="movie">
		SELECT * FROM movie_tbl WHERE movie_no = #{movieNo}
	</select>

	<select id="getMovieNo" resultType="int">
		SELECT movie_seq.NEXTVAL FROM dual
	</select>

	<update id="updateMovieStatus">
		UPDATE movie_tbl
		SET movie_status = #{movieStatus}
		WHERE movie_no = #{movieNo}
	</update>

	<insert id="insertMovieInfo">
		INSERT INTO movie_tbl (
			movie_no, movie_type, movie_title, movie_status,
			movie_content, movie_thumb, movie_genre, movie_grade,
			movie_runtime, movie_director, movie_actor, movie_release
		)
		VALUES (
			movie_seq.nextval,
			#{movieType}, #{movieTitle}, #{movieStatus}, #{movieContent},
			#{movieThumb}, #{movieGenre}, #{movieGrade}, #{movieRuntime},
			#{movieDirector}, #{movieActor}, #{movieRelease}
		)
	</insert>

	
<select id="totalCount" resultType="int" parameterType="map">
    SELECT COUNT(*)
    FROM movie_tbl
    <where>
        <if test="movieTitle != null and movieTitle != ''">
            AND movie_title LIKE '%' || #{movieTitle} || '%'
        </if>
        <if test="movieStatus != null">
            AND movie_status = #{movieStatus}
        </if>
    </where>
</select>

	<insert id="insertSchedule">
		INSERT INTO schedule_tbl (
			schedule_no,
			movie_no,
			screen_no,
			movie_title,
			schedule_time_start,
			schedule_time_end,
			schedule_open,
			schedule_close
		)
		VALUES (
			schedule_seq.nextval,
			#{movieNo},
			#{screenNo},
			#{movieTitle},
			#{scheduleTimeStart},
			#{scheduleTimeEnd},
			#{scheduleOpen},
			#{scheduleClose}
		)
	</insert>

	<select id="getRunningMovies" resultType="movie">
	    SELECT movie_no, movie_title, movie_thumb, movie_status
	    FROM movie_tbl
	    WHERE movie_status = 2
	</select>

	<select id="scheduleList" resultType="schedule">
	    SELECT
	        s.schedule_no AS scheduleNo,
	        s.movie_no AS movieNo,
	        m.movie_title AS movieTitle,
	        s.screen_no AS screenNo,
	        TO_CHAR(s.schedule_open, 'YYYY-MM-DD') AS scheduleOpen,
	        TO_CHAR(s.schedule_close, 'YYYY-MM-DD') AS scheduleClose,
	        s.schedule_time_start AS scheduleTimeStart,
	        s.schedule_time_end AS scheduleTimeEnd
	    FROM schedule_tbl s
	    JOIN movie_tbl m ON s.movie_no = m.movie_no
	    ORDER BY s.schedule_no DESC
	</select>

	<update id="updateSchedule">
	    UPDATE schedule_tbl
	    SET
	        screen_no = #{screenNo},
	        schedule_open = TO_DATE(#{scheduleOpen}, 'YYYY-MM-DD'),
	        schedule_close = TO_DATE(#{scheduleClose}, 'YYYY-MM-DD'),
	        schedule_time_start = #{scheduleTimeStart},
	        schedule_time_end = #{scheduleTimeEnd}
	    WHERE schedule_no = #{scheduleNo}
	</update>

	<delete id="deleteSchedule" parameterType="int">
	    DELETE FROM schedule_tbl WHERE schedule_no = #{scheduleNo}
	</delete>

</mapper>
